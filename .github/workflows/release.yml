name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  # Linux build (PortAudio microphone)
  release-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"

      - name: Install PortAudio dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y portaudio19-dev libportaudio2

      - name: Build Linux binary
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -ldflags "-s -w" -o spank-linux-amd64 .
          tar czf spank-linux-amd64.tar.gz spank-linux-amd64 audio/

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: spank-linux-amd64.tar.gz

  # Windows build (PortAudio with bundled DLL)
  release-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"

      - name: Install PortAudio
        run: |
          vcpkg install portaudio:x64-windows

      - name: Build Windows binary (with bundled DLL)
        shell: pwsh
        run: |
          $env:CGO_ENABLED = "1"
          $env:PKG_CONFIG_PATH = "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\lib\pkgconfig"
          go build -ldflags "-s -w" -o spank-windows-amd64.exe .
          Compress-Archive -Path "spank-windows-amd64.exe","portaudio.dll","audio" -DestinationPath "spank-windows-amd64.zip"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: spank-windows-amd64.zip

  # Create release with both binaries
  create-release:
    needs: [release-linux, release-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-binary
          path: artifacts

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-binary
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/spank-linux-amd64.tar.gz
            artifacts/spank-windows-amd64.zip
          generate_release_notes: true
          body: |
            ## Cross-Platform Slap Detector

            ### Linux (PortAudio + Microphone)
            - **File:** `spank-linux-amd64.tar.gz`
            - **Requirements:** Linux with PortAudio, microphone
            - **Install deps:** `sudo apt install libportaudio2 portaudio19-dev`
            - **Usage:**
              ```bash
              ./spank                    # Pain mode (default)
              ./spank --sexy             # Sexy mode
              ./spank --halo             # Halo mode
              ./spank --threshold 3000   # Adjust sensitivity
              ```

            ### Windows (PortAudio + Microphone)
            - **File:** `spank-windows-amd64.zip`
            - **Requirements:** Windows 10/11 with microphone
            - **Self-contained** - PortAudio DLL included in zip, just extract and run!
            - **Usage:
              ```powershell
              spank.exe                    # Pain mode (default)
              spank.exe --sexy             # Sexy mode
              spank.exe --halo             # Halo mode
              spank.exe --threshold 3000   # Adjust sensitivity
              ```

            ### macOS
            macOS build requires private repository access. Build from source on Apple Silicon Mac.

            ### Modes
            - `Pain mode` - Random pain sounds
            - `Sexy mode` - Escalating responses
            - `Halo mode` - Halo death sounds

            [中文说明](README_CN.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
