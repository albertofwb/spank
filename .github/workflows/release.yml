name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  # Linux build (PortAudio microphone)
  release-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - uses: actions/setup-go@v5
        with:
          go-version: "1.26"

      - name: Install PortAudio dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y portaudio19-dev libportaudio2

      - name: Build Linux binary
        run: |
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -ldflags "-s -w" -o spank-linux-amd64 .
          tar czf spank-linux-amd64.tar.gz spank-linux-amd64 audio/

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-binary
          path: spank-linux-amd64.tar.gz

  # Create release with Linux binary
  create-release:
    needs: [release-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-binary
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/spank-linux-amd64.tar.gz
          generate_release_notes: true
          body: |
            ## Cross-Platform Slap Detector

            ### Linux (PortAudio + Microphone)
            - **File:** `spank-linux-amd64.tar.gz`
            - **Requirements:** Linux with PortAudio, microphone
            - **Install deps:** `sudo apt install libportaudio2 portaudio19-dev`
            - **Usage:**
              ```bash
              ./spank                    # Pain mode (default)
              ./spank --sexy             # Sexy mode
              ./spank --halo             # Halo mode
              ./spank --threshold 3000   # Adjust sensitivity
              ```

            ### Windows
            Windows build requires local compilation with PortAudio. Build from source:
            ```powershell
            # Install PortAudio (via vcpkg or download prebuilt)
            vcpkg install portaudio:x64-windows

            # Build
            $env:CGO_ENABLED=1
            go build -o spank.exe .
            ```

            ### macOS
            macOS build requires private repository access. Build from source on Apple Silicon Mac.

            ### Modes
            - `Pain mode` - Random pain sounds
            - `Sexy mode` - Escalating responses
            - `Halo mode` - Halo death sounds

            [中文说明](README_CN.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
